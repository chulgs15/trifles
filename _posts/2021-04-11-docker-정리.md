---
published: true
layout: single
title: "[작성중]Docker 정리"
comments: true
classes: wide
categories:
  - blog
tags:
  - [typora, trifles]
date: 2021-04-11
last_modified_at: 2021-04-11
---
아직은 정리중인 문서.

## Copy

* Copy 라는 명령어를 이용해서 package.json을 복사한다.

## 접근 에러

* docker run -p 49160:8080 이미지
* Port 포워딩을 사용하네.

## WORKDIR

* 이미지 안에서 어플 소스 코드를 갖고 있을 디렉토리를 생성.

* 왜 별도로 있어야 하나? 빌드한 이미지로 안되나?

  * 소스가 무조건 Root 가 복사되어 지저분해지네.

  * 베이스 이미지에 이미 같은 파일을 있다면 덮어씌우기를 진행한다.

* 소스

  * ```
    WORKDIR /usr/src/app
    ```
  
  * WORKDIR 를 설정하면 맨 처음 접속하는 폴더로 설정한다. 

## 재빌드 문제

* 변경한 소스코드를 반영하려면 
  * 도커 끄기
  * 소스 변경
  * 도커 재빌드.
    * 재빌드 시, npm install 로 인해 다시 모듈을 다운로드 받아야 한다.
  
* -d : Detach 옵션, 프로그램 실행 후 종료. id 만 뱉는다. 

* COPY 를 2번 사용해서 재빌드 문제를 해결.

  * 기존 소스코드는 전체 소스를 COPY 하기 때문에 모든 모듈을 npm install 로 다시 다운로드 받는다.

  * ```
    COPY ./ ./
    
    RUN npm install
    ```

  * 아래와 같이 바꾸면 먼저 package.json 으로 발생하는 

  * ```
    COPY package.json ./
    
    RUN npm install
    
    COPY ./ ./
    ```

    

* 이상한 점은 `COPY ./ ./` 가 전체 소스 복사인데 package.json 도 같이 복사잖아?
  * 그러면 수정한 소스와 동일한것이 아닌가?
  * RUN npm install 은 전체 소스 복사가 일어나면 다시 종속성을 다운로든 받는 기능이 있는 것 같음.
* Cache 를 이용해서 build 를 두번하지 않는다.
  * 아 이제 이해가 가는것 같다. 
    * https://jonnung.dev/docker/2020/04/08/optimizing-docker-images/
  * COPY 명령어를 수행하면 이미지를 캐싱한다
    * COPY package.json 을 하는 순간 기존 캐시를 버리고 새로운 캐시를 만든다.
* 여기 재빌드가 npm의 Build 문제가 아니라 Docker의 Build 문제였네.
  * 변경 소스 : 소스 변경 없이 재빌드
  * ![image-20210412095326335](C:\Users\comscg\AppData\Roaming\Typora\typora-user-images\image-20210412095326335.png)
  * 소스 수정 후 다시 빌드
  * ![image-20210412095335305](C:\Users\comscg\AppData\Roaming\Typora\typora-user-images\image-20210412095335305.png)
  * 기존 소스 : 소스 변경 없이 재빌드
  * ![image-20210412095454492](C:\Users\comscg\AppData\Roaming\Typora\typora-user-images\image-20210412095454492.png)
  * 소스 수정 후 다시 빌드
  * ![image-20210412095620692](C:\Users\comscg\AppData\Roaming\Typora\typora-user-images\image-20210412095620692.png)
  * 상위 COPY의 이미지가 변경이 생기면 캐싱한 COPY 이미지를 버린다. 아래 RUN 이미지도 마찬가지로 캐싱한 이미지를 버린다.
    * 그러니 npm install 한 과거 캐싱한 이미지가 사라져서 다시 빌드하면 npm install 을 다시하는 거네 
    * 상위 COPY 에 변경이 생기지 않도록 PACKAGE.JSON 을 먼저 옮기고 빌드하는거네...