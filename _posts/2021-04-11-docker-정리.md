---
published: true
layout: single
title: "[작성중]Docker 정리"
comments: true
classes: wide
categories:
  - blog
tags:
  - [typora, trifles]
date: 2021-04-11
last_modified_at: 2021-04-11
---
아직은 정리중인 문서.

## Copy

* Copy 라는 명령어를 이용해서 package.json을 복사한다.

## 접근 에러

* docker run -p 49160:8080 이미지
* Port 포워딩을 사용하네.

## WORKDIR

* 이미지 안에서 어플 소스 코드를 갖고 있을 디렉토리를 생성.

* 왜 별도로 있어야 하나? 빌드한 이미지로 안되나?

  * 소스가 무조건 Root 가 복사되어 지저분해지네.

  * 베이스 이미지에 이미 같은 파일을 있다면 덮어씌우기를 진행한다.

* 소스

  * ```
    WORKDIR /usr/src/app
    ```
  
  * WORKDIR 를 설정하면 맨 처음 접속하는 폴더로 설정한다. 

## 재빌드 문제

* 변경한 소스코드를 반영하려면 
  * 도커 끄기
  * 소스 변경
  * 도커 재빌드.
    * 재빌드 시, npm install 로 인해 다시 모듈을 다운로드 받아야 한다.
  
* -d : Detach 옵션, 프로그램 실행 후 종료. id 만 뱉는다. 

* COPY 를 2번 사용해서 재빌드 문제를 해결.

  * 기존 소스코드는 전체 소스를 COPY 하기 때문에 모든 모듈을 npm install 로 다시 다운로드 받는다.

  * ```
    COPY ./ ./
    
    RUN npm install
    ```

  * 아래와 같이 바꾸면 먼저 package.json 으로 발생하는 

  * ```
    COPY package.json ./
    
    RUN npm install
    
    COPY ./ ./
    ```

    

* 이상한 점은 `COPY ./ ./` 가 전체 소스 복사인데 package.json 도 같이 복사잖아?
  * 그러면 수정한 소스와 동일한것이 아닌가?
  * RUN npm install 은 전체 소스 복사가 일어나면 다시 종속성을 다운로든 받는 기능이 있는 것 같음.
* Cache 를 이용해서 build 를 두번하지 않는다.
  * 아 이제 이해가 가는것 같다. 
    * https://jonnung.dev/docker/2020/04/08/optimizing-docker-images/
  * COPY 명령어를 수행하면 이미지를 캐싱한다
    * COPY package.json 을 하는 순간 기존 캐시를 버리고 새로운 캐시를 만든다.
* 여기 재빌드가 npm의 Build 문제가 아니라 Docker의 Build 문제였네.
  * 변경 소스 : 소스 변경 없이 재빌드
  
  * ![image-20210412095326335](C:\Users\comscg\AppData\Roaming\Typora\typora-user-images\image-20210412095326335.png)
  
  * 소스 수정 후 다시 빌드
  
  * ![image-20210412095335305](C:\Users\comscg\AppData\Roaming\Typora\typora-user-images\image-20210412095335305.png)
  
  * 기존 소스 : 소스 변경 없이 재빌드
  
  * ![image-20210412095454492](C:\Users\comscg\AppData\Roaming\Typora\typora-user-images\image-20210412095454492.png)
  
  * 소스 수정 후 다시 빌드
  
  * ![image-20210412095620692](C:\Users\comscg\AppData\Roaming\Typora\typora-user-images\image-20210412095620692.png)
  
  * 상위 COPY의 이미지가 변경이 생기면 캐싱한 COPY 이미지를 버린다. 아래 RUN 이미지도 마찬가지로 캐싱한 이미지를 버린다.
    * 그러니 npm install 한 과거 캐싱한 이미지가 사라져서 다시 빌드하면 npm install 을 다시하는 거네 
    * 상위 COPY 에 변경이 생기지 않도록 PACKAGE.JSON 을 먼저 옮기고 빌드하는거네...
    
  * 여기서 아래와 같이 테스트
  
    * Text.txt 텍스트를 추가.
  
    * 순서를 아래와 같이 지정.
  
    * ```
      COPY package.json ./
      
      COPY Test.txt ./
      
      RUN npm install
      
      COPY ./ ./
      
      CMD ["node", "server.js"]
      ```
  
      
  
    * 만약 Test.txt 에 변화가 생기면 아래 3개의 작업은 캐싱을 버리고 다시 진행함.
  
    * 사실일까?
  
      * ![image-20210413090815918](C:\Users\comscg\AppData\Roaming\Typora\typora-user-images\image-20210413090815918.png){: .align-center}
  
      * Test.txt 파일 변경.
  
        * 예상대로 아래 3개 작업의 이미지 캐싱을 버림. 그래서 npm install 을 재사용하는 이유가 이것이라는 것을 알수 있음.
  
          ![image-20210413090905519](C:\Users\comscg\AppData\Roaming\Typora\typora-user-images\image-20210413090905519.png){: .align-center}

## Docker Volume

* Volumn
  * http://pyrasis.com/book/DockerForTheReallyImpatient/Chapter06/04
    * Docker 데이터 Voumn 은 데이터를 컨테이너가 아닌 호스트에 저장하는 방식이다.
    * 따라서 데이터 볼륨은 컨테이너끼리 데이터를 고융할 때 활용할 수 있습니다. 
  * 참조시키는 기능
  * ![image-20210413163655337](C:\Users\comscg\AppData\Roaming\Typora\typora-user-images\image-20210413163655337.png)

* Volumn 사용해서 어플리케이션 실행 방법.
  * 제외할 폴더와 포함할 폴더를 구분하네.
    * 컨셉은 알겠는데 이게 뭔소리인지 잘 모르겠네...
  * 제외할 폴더와 포함할 폴더를 같은 옵션을 주는데...
    * 
* 내 생각의 장점은 이렇다
  * Docker 에 소스를 전달하고 다시 Build 하는 작업은 불필요한 작업니다.
    * 소스는 Local Host 에서 수정하고 다시 Docker 에게 COPY하면 이중 보관이 된다.
    * 만약 소스의 크기가 GB 단위라면 COPY가 오래 걸릴것이다.
      * 이미지, 동영상 등 여러 파일들이 존재할 수 있으니까....
  * 그러면 소스는 Local Host 한곳에만 보관하고 Build 시 Localhost 참조한다면?
    * 기존 작업인 Host to Docker Copy -> Build. 가...
    * Host 의 소스 참조 -> Build 로 바뀌게 된다.
    * 결국 Docker 는 빌드한 이미지만 남게 될 것이다.